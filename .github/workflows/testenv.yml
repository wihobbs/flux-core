# vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab:
on: 
  workflow_dispatch:
    inputs:
      distro:
        description: 'Distro for which to rebuild testenv manifest'
        required: true
        default: 'noble'
        type: choice
        options:
        - noble
        - el9
        - el8
        - bookworm
        - alpine
        - fedora40
        - jammy
        - focal
        - trixie
name: rebuild testenv containers using docker buildx
jobs:
  build-amd64-container:
    name: build new testenv container for amd64
    runs-on: ubuntu-latest
    env: 
      DOCKERHUB_REPO: wihobbs
    outputs:
      image_digest: ${{ steps.digest.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and tar amd64 image
        id: build
        run: |
          set -euo pipefail
          mkdir -p out
          docker buildx build \
            -o type=docker,dest=out/testenv-${{ inputs.distro }}-amd64.tar \
            --platform=linux/amd64 \
            --tag $DOCKERHUB_REPO/testenv:${{ inputs.distro }}-amd64 \
            -f src/test/docker/${{ inputs.distro }}/Dockerfile .

      - name: Upload amd64 container tarball
        uses: actions/upload-artifact@v4
        with:
          name: testenv-${{ inputs.distro }}-amd64
          path: out/testenv-${{ inputs.distro }}-amd64.tar
          if-no-files-found: error
  
  build-arm64-container:
    name: build new testenv container for arm64
    runs-on: ubuntu-24.04-arm
    env: 
      DOCKERHUB_REPO: wihobbs
    outputs:
      image_digest: ${{ steps.digest.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and tar arm64 image
        id: build
        run: |
          set -euo pipefail
          mkdir -p out
          docker buildx build \
            -o type=docker,dest=out/testenv-${{ inputs.distro }}-arm64.tar \
            --platform=linux/arm64 \
            --tag $DOCKERHUB_REPO/testenv:${{ inputs.distro }}-arm64 \
            -f src/test/docker/${{ inputs.distro }}/Dockerfile .

      - name: Upload arm64 container tarball
        uses: actions/upload-artifact@v4
        with:
          name: testenv-${{ inputs.distro }}-arm64
          path: out/testenv-${{ inputs.distro }}-arm64.tar
          if-no-files-found: error

  publish-manifest:
    name: Push images + publish multi-arch manifest
    needs:
      - build-amd64-container
      - build-arm64-container
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_REPO: wihobbs
      DOCKER_USERNAME: wihobbs
      DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TRAVISFLUX_TOKEN }}
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: docker login
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: testenv-${{ inputs.distro }}-amd64
          path: artifacts

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: testenv-${{ inputs.distro }}-arm64
          path: artifacts

      - name: Load images from tarballs
        run: |
          set -euo pipefail
          docker load -i artifacts/testenv-${{ inputs.distro }}-amd64.tar
          docker load -i artifacts/testenv-${{ inputs.distro }}-arm64.tar
          docker images | head -n 50

      # Push arch-specific tags first
#       - name: Push per-arch tags
#         run: |
#           set -euo pipefail
#           AMD_TAG="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}-amd64"
#           ARM_TAG="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}-arm64"
# 
#           docker push "${AMD_TAG}"
#           docker push "${ARM_TAG}"
# 
      # Then create the multi-arch manifest that points at the per-arch tags
      - name: Create and push manifest
        run: |
          set -euo pipefail
          IMAGE="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}"
          AMD_TAG="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}-amd64"
          ARM_TAG="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}-arm64"

          docker buildx imagetools create \
            --tag "${IMAGE}" \
            "${AMD_TAG}" \
            "${ARM_TAG}"

      - name: Inspect published manifest
        run: |
          set -euo pipefail
          docker buildx imagetools inspect ${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}

##   build-amd64-container:
##     name: build new testenv container for arm
##     runs-on: ubuntu-latest
##     env:
##       DOCKERHUB_REPO: wihobbs
##       DOCKER_USERNAME: wihobbs
##       DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TRAVISFLUX_TOKEN }}
##     steps:
##       -
##         name: Checkout
##         uses: actions/checkout@v5
##       -
##         # Add support for more platforms with QEMU (optional)
##         # https://github.com/docker/setup-qemu-action
##         name: Set up QEMU
##         uses: docker/setup-qemu-action@v3
##       -
##         name: Set up Docker Buildx
##         uses: docker/setup-buildx-action@v3
##       -
##         name: docker login
##         uses: docker/login-action@v3.6.0
##         with:
##           username: ${{ env.DOCKER_USERNAME }}
##           password: ${{ env.DOCKER_PASSWORD }}
##       -
##         name: Build the actual containers
##         run: docker buildx build --push --platform=linux/amd64 --tag $DOCKERHUB_REPO/testenv:${{ inputs.distro }} -f src/test/docker/${{ inputs.distro }}/Dockerfile .
## 
##   build-arm-container:
##     name: build new testenv container for arm
##     runs-on: ubuntu-24.04-arm
##     env:
##       DOCKERHUB_REPO: wihobbs
##       DOCKER_USERNAME: wihobbs
##       DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TRAVISFLUX_TOKEN }}
##     steps:
##       -
##         name: Checkout
##         uses: actions/checkout@v5
##       -
##         # Add support for more platforms with QEMU (optional)
##         # https://github.com/docker/setup-qemu-action
##         name: Set up QEMU
##         uses: docker/setup-qemu-action@v3
##       -
##         name: Set up Docker Buildx
##         uses: docker/setup-buildx-action@v3
##       -
##         name: docker login
##         uses: docker/login-action@v3.6.0
##         with:
##           username: ${{ env.DOCKER_USERNAME }}
##           password: ${{ env.DOCKER_PASSWORD }}
##       -
##         name: Build the actual containers
##         run: docker buildx build --push --platform=linux/arm64 --tag $DOCKERHUB_REPO/testenv:${{ inputs.distro }} -f src/test/docker/${{ inputs.distro }}/Dockerfile .
## 
##   publish-manifest:
##     name: Publish multi-arch manifest
##     needs:
##       - build-amd64-container
##       - build-arm-container
##     runs-on: ubuntu-latest
##     env:
##       DOCKERHUB_REPO: wihobbs
##       DOCKER_USERNAME: wihobbs
##       DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TRAVISFLUX_TOKEN }}
##     steps:
##       - name: Set up Docker Buildx
##         uses: docker/setup-buildx-action@v3
## 
##       - name: docker login
##         uses: docker/login-action@v3.6.0
##         with:
##           username: ${{ env.DOCKER_USERNAME }}
##           password: ${{ env.DOCKER_PASSWORD }}
## 
##       # This creates (or updates) the tag to be a manifest list containing both arches.
##       # It relies on the two arch-specific images already existing under the same tag.
##       - name: Create and push manifest
##         run: |
##           set -euo pipefail
##           IMAGE="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}"
## 
##           docker buildx imagetools create \
##             --tag "${IMAGE}" \
##             "${IMAGE}"
## 
##       - name: Inspect published manifest
##         run: |
##           set -euo pipefail
##           IMAGE="${DOCKERHUB_REPO}/testenv:${{ inputs.distro }}"
##           docker buildx imagetools inspect "${IMAGE}"
## 
## 
#   create-manifest:
#     name: create docker manifest from amd64/arm64 builds
#     runs-on: ubuntu-latest
#     needs: [build-amd64-container, build-arm-container]
#     env:
#       DOCKERHUB_REPO: wihobbs
#       DOCKER_USERNAME: wihobbs
#       DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TRAVISFLUX_TOKEN }}
#     steps:
#       - 
#         name: docker login
#         uses: docker/login-action@v3.6.0
#         with:
#           username: ${{ env.DOCKER_USERNAME }}
#           password: ${{ env.DOCKER_PASSWORD }}
#       - 
#         name: create docker manifest
#         run: 
#  run-make-check-amd64:
#    name: run make check in newly-built testenv containers
#    runs-on: ubuntu-latest
#    needs: build-containers
#    steps:
#    - name: docker run make check
#      run: docker run $DOCKERHUB_REPO/testenv:${{ inputs.distro }} echo "hello"
#  run-make-check-arm:
#    name: run make check in newly-built testenv containers
#    runs-on: ubuntu-24.04-arm
#    needs: build-containers
#    steps:
#    - name: docker run make check
#      run: docker run $DOCKERHUB_REPO/testenv:${{ inputs.distro }} echo "hello"
#   create-manifest:
#     runs-on: ubuntu-latest
#     needs: [build-containers, run-make-check-arm64, run-make-check-amd64]
#     steps: 
#   
